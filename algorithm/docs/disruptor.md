# Disruptor数据结构算法

## 内存消息队列
非循环的顺序队列在添加、删除数据的工程中，会涉及数据的搬移操作，导致性能变差。
而循环队列正好可以解决这个数据搬移的问题，所以，性能更加好。
所以，大部分用到顺序队列的场景中，我们都选择用顺序队列中的循环队列。

## 并发操作队列问题
* 多个生产者写入的数据可能会互相覆盖； 
* 多个消费者可能会读取重复的数据
### 方案1 加锁
加锁，同一时间只允许一个线程执行，加锁将并行改成串行，必然导致多个生产者同时生产数据的时候，
执行效率的下降。
### 方案2 无锁
Disruptor 采用了“两阶段写入”的方法。在写入数据之前，先**加锁**申请批量的空闲存储单元，
之后往队列中写入数据的操作就不需要加锁了，写入的性能因此就提高了。

Disruptor 对消费过程的改造，跟对生产过程的改造是类似的。它先加锁申请批量的可读取的存储单元，
之后从队列中读取数据的操作也就不需要加锁了，读取的性能因此也就提高了。

### 比较
CAS操作比单线程无锁慢了1个数量级；有锁且多线程并发的情况下，速度比单线程无锁慢3个数量级。可见无锁速度最快。

单线程情况下，不加锁的性能 > CAS操作的性能 > 加锁的性能。

在多线程情况下，为了保证线程安全，必须使用CAS或锁，这种情况下，CAS的性能超过锁的性能，前者大约是后者的8倍。

## 应用
包括Apache Storm、Camel、Log4j 2在内的很多知名项目都应用了Disruptor以获取高性能。

## 参考
* [**数据结构与算法之美**](http://gk.link/a/10p9l)
* [高性能队列——Disruptor](https://tech.meituan.com/2016/11/18/disruptor.html)